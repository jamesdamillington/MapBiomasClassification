---
title: "MapBiomasClassification"
output: 
  html_document: 
    keep_md: yes
---

##Load Libraries
```{r warning=F, message=F}

rm(list=ls())
library(tidyverse)
library(raster)
library(readxl)

```

##Functions
```{r}

#raster to xyz  (with help from https://stackoverflow.com/a/19847419)
#sepcify input raster, whether nodata cells should be output, whether a unique cell ID should be added
#return is a matrix. note format is row (Y) then col (X)
extractXYZ <- function(raster, nodata = FALSE, addCellID = TRUE){
  
  vals <- raster::extract(raster, 1:ncell(raster))   #specify raster otherwise dplyr used
  xys <- rowColFromCell(raster,1:ncell(raster))
  combine <- cbind(xys,vals)
  
  if(addCellID){
    combine <- cbind(1:length(combine[,1]), combine)
  }
  
  if(!nodata){
    combine <- combine[!rowSums(!is.finite(combine)),]  #from https://stackoverflow.com/a/15773560
  }
  
  return(combine)
}


getLCs <- function(data)
{
  #calculates proportion of each LC in the muni (ignoring NAs, help from https://stackoverflow.com/a/44290753)
  data %>%
    group_by(muniID) %>%
    dplyr::summarise(LC1 = round(sum(map == 1, na.rm = T) / sum(!is.na(map)), 3),
                     LC2 = round(sum(map == 2, na.rm = T) / sum(!is.na(map)), 3),
                     LC3 = round(sum(map == 3, na.rm = T) / sum(!is.na(map)), 3),
                     LC4 = round(sum(map == 4, na.rm = T) / sum(!is.na(map)), 3),
                     LC5 = round(sum(map == 5, na.rm = T) / sum(!is.na(map)), 3),
                     NonNAs = sum(!is.na(map)),
                     NAs = sum(is.na(map))
    ) -> LCs

  return(LCs)
}


```

##Load Data
Maps from Zip
```{r}

unzip(zipfile="MapBiomas_23_ASCII_unclassified_allYears.zip",files="ASCII/brazillc_2000_5km_int.txt")  # unzip file 
map <- raster("ASCII/brazillc_2000_5km_int.txt") 
plot(map) 

```


Classification from Excel
```{r warning=F, message=F}

classification <- read_excel("MapBiomas_CRAFTY_classifications.xlsx", sheet = "PastureB", range="B2:C21", col_names=F)  

```

MapBiomas land areas from csv (areas are km2)
```{r warning=F, message=F}

mb_areas <- read_csv("LandCover Data - MapBiomas - Collection 2.3 - 2018.01.04 Municipios.csv")  


```


##Classify
```{r}

map <- reclassify(map, rcl=as.matrix(classification))
plot(map, col=c("green", "pink", "yellow", "grey", "brown"))

```


##Compare map areas to MapBiomas area 
Let's compare areas at the state level for the 10 states being simulated. These are:
IBGE CODE	STATE
17	Tocantins
29	Bahia
31	Minas Gerais
35	São Paulo
41	Paraná
42	Santa Catarina
43	Rio Grande do Sul
50	Mato Grosso do Sul
51	Mato Grosso
52	Goiás

Create a summary table of classified map data for municipalities in states we are simulating 
```{r}

munis.r <- raster("sim10_BRmunis_latlon_5km_2018-04-27.asc")  #do this with zip file

#extract cell values to table format
munis.t <- extractXYZ(munis.r, addCellID = F)
map.t <- extractXYZ(map, addCellID = F)

munis.t <- as.data.frame(munis.t)
munis.t <- plyr::rename(munis.t, c("vals" = "muniID"))


map.t <- as.data.frame(map.t)
map.t <- plyr::rename(map.t, c("vals" = "map"))

#so need to join 
map_munis <- left_join(as.data.frame(munis.t), as.data.frame(map.t), by = c("row" = "row", "col" = "col"))

#now summarise by muniID
lcs_map <- getLCs(map_munis)

#convert cell counts to areas (km2)
area_km <- lcs_map %>%
  mutate(LC1area = round(LC1 * NonNAs) * 25) %>%
  mutate(LC2area = round(LC2 * NonNAs) * 25) %>%
  mutate(LC3area = round(LC3 * NonNAs) * 25) %>%
  mutate(LC4area = round(LC4 * NonNAs) * 25) %>%
  mutate(LC5area = round(LC5 * NonNAs) * 25)

area_km <- area_km %>% dplyr::select(-LC1, -LC2, -LC3, -LC4, -LC5, -NonNAs, -NAs)


```


##Clean up
```{r}

unlink("ASCII", recursive = T) #delete ASCII directory created above

```
